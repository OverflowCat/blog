<!DOCTYPE html><head><meta charset=utf-8><link href=/_astro/three-keys-hello-world-in-powershell.db3208af.css rel=stylesheet /></head><blockquote><p>为什么不试试 M$ 的功率壳呢？</p></blockquote><p>其实 <a href=https://github.com/InvoluteHell/ThreeKeysProgramming/tree/master/OverflowCat>这篇文章</a> 在去年暑假就已经写好，不过最近我的 <a href=https://github.com/InvoluteHell/ThreeKeysProgramming/pull/36>pull request</a> 才被合并，已经快忘掉了。现修缮后发出来。</p><h2 id=规则>规则</h2><p>三键成码一项编程比赛，要求参赛者仅用三个字母或数字以及任意数量的符号编码输出 <code>Hello, World!</code>，并且文件体积最小者获胜。以下是详细规则：</p><blockquote><ol><li>参赛选手自行挑选三个「字母 / 数字」来编写代码，代码中的「字母 / 数字」<strong>只能且必须</strong> 有这三个（大小写算两个不同的键）</li><li>除此三个「字母 / 数字」外，额外允许使用普通键盘上的所有 ASCII 符号（例如 <code>{</code>, <code>;</code> 等）</li><li>该程序运行后输出 <code>Hello, World!</code>, 有且仅有该内容，要求分毫不差，注意大小写和符号</li><li>上传的所有文件体积最小者获胜！（结果截图、说明文档等的不算）</li><li>不限编程语言，但禁止使用极小众语言；我们对极小众的定义是：<a href=https://madnight.github.io/githut/#/pull_requests/2022/1>Github 语言统计</a> 上从未出现过的语言</li><li>所有的依赖条件均需是在本比赛开始前就是已有的；否则请上传，作为文件内容统计的一部分！</li><li>要求使用平庸的编译/执行命令、测试环境、文件名，除平庸部分外，其余部分也需要符合上述 1, 2 两条的要求</li><li>静态类型语言的入口函数名，不受 1 中的限制。例如 C 语言的 <code>int main</code>, Java 的 <code>public static void main</code> 等</li></ol></blockquote><p>截至 2023 年 3 月，PowerShell 在 GitHub 使用量排第 32 名，占比 0.102%，符合要求。<sup><a href=#user-content-fn-3psrank aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3psrank>1</a></sup></p><h2 id=代码>代码</h2><p>选择的 3 个字母：<code>i</code>、<code>e</code>、<code>x</code>。</p><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#2f86d2>$i</span><span style=color:#7b30d0>=</span><span style=color:#002339>$?</span><span style=color:#7b30d0>+</span><span style=color:#002339>$?</span></span>
<span class=line><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$i</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span></span>
<span class=line><span style=color:#2f86d2>$xi</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span></span>
<span class=line><span style=color:#2f86d2>$xe</span><span style=color:#7b30d0>=</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span></span>
<span class=line><span style=color:#2f86d2>$xx</span><span style=color:#7b30d0>=</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>+--</span><span style=color:#2f86d2>$e</span></span>
<span class=line><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#002339>(</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#002339>$?)[</span><span style=color:#2f86d2>$i</span><span style=color:#002339>]</span></span>
<span class=line><span style=color:#002339>iex </span><span style=color:#a44185>"</span><span style=color:#174781>`$</span><span style=color:#a44185>ex=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xe</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>;</span><span style=color:#174781>`$</span><span style=color:#a44185>xe=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xx</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>"</span></span>
<span class=line><span style=color:#2f86d2>$ii</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>+++</span><span style=color:#2f86d2>$i</span></span>
<span class=line><span style=color:#2f86d2>$ix</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$ii</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span></span>
<span class=line><span style=color:#2f86d2>$ei</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>*</span><span style=color:#2f86d2>$i</span></span>
<span class=line><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#a44185>"</span><span style=color:#174781>``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{"</span></span>
<span class=line><span style=color:#002339>iex </span><span style=color:#a44185>"</span><span style=color:#174781>`$</span><span style=color:#a44185>e=</span><span style=color:#174781>""</span><span style=color:#2f86d2>$x$e$ei</span><span style=color:#a44185>}e</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$ex</span><span style=color:#a44185>}, </span><span style=color:#2f86d2>$x$ii$ix</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$ex</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$ix$i</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$e</span><span style=color:#a44185>}!</span><span style=color:#174781>""</span><span style=color:#a44185>"</span></span>
<span class=line><span style=color:#2f86d2>$e</span></span></code></pre></div><p>压成一行时语句结尾需要有分号。</p><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#2f86d2>$i</span><span style=color:#7b30d0>=</span><span style=color:#002339>$?</span><span style=color:#7b30d0>+</span><span style=color:#002339>$?;</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$i</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span><span style=color:#002339>;</span><span style=color:#2f86d2>$xi</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span><span style=color:#002339>;</span><span style=color:#2f86d2>$xe</span><span style=color:#7b30d0>=</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span><span style=color:#002339>;</span><span style=color:#2f86d2>$xx</span><span style=color:#7b30d0>=</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>+--</span><span style=color:#2f86d2>$e</span><span style=color:#002339>;</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#002339>(</span><span style=color:#a44185>""</span><span style=color:#7b30d0>+</span><span style=color:#002339>$?)[</span><span style=color:#2f86d2>$i</span><span style=color:#002339>];iex </span><span style=color:#a44185>"</span><span style=color:#174781>`$</span><span style=color:#a44185>ex=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xe</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>;</span><span style=color:#174781>`$</span><span style=color:#a44185>xe=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xx</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>"</span><span style=color:#002339>;</span><span style=color:#2f86d2>$ii</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>+++</span><span style=color:#2f86d2>$i</span><span style=color:#002339>;</span><span style=color:#2f86d2>$ix</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$ii</span><span style=color:#7b30d0>+</span><span style=color:#2f86d2>$i</span><span style=color:#002339>;</span><span style=color:#2f86d2>$ei</span><span style=color:#7b30d0>=</span><span style=color:#2f86d2>$e</span><span style=color:#7b30d0>*</span><span style=color:#2f86d2>$i</span><span style=color:#002339>;</span><span style=color:#2f86d2>$x</span><span style=color:#7b30d0>=</span><span style=color:#a44185>"</span><span style=color:#174781>``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{"</span><span style=color:#002339>;iex </span><span style=color:#a44185>"</span><span style=color:#174781>`$</span><span style=color:#a44185>e=</span><span style=color:#174781>""</span><span style=color:#2f86d2>$x$e$ei</span><span style=color:#a44185>}e</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$ex</span><span style=color:#a44185>}, </span><span style=color:#2f86d2>$x$ii$ix</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$ex</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$ix$i</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$xe</span><span style=color:#a44185>}</span><span style=color:#2f86d2>$x$xi$e</span><span style=color:#a44185>}!</span><span style=color:#174781>""</span><span style=color:#a44185>"</span><span style=color:#002339>;</span><span style=color:#2f86d2>$e</span></span></code></pre></div><h3 id=环境>环境</h3><p><strong>PowerShell 7.2.5</strong>，需要自行安装，Windows 自带的版本较旧，没有 Unicode 转义字符。</p><p>代码可以在终端直接粘贴，或者通过 <code>.\x.ps1</code> 运行。</p><h2 id=原理>原理</h2><h3 id=选择字母>选择字母</h3><p>让我们先来看看其他提交者所用的语言中是怎么做到的：</p><ul><li>JavaScript 有 <a href=http://www.jsfuck.com/ >JSFuck</a> 这种东西，甚至可以只有符号，自然是不消说的</li><li>Python 版本中选择了 <code>exec</code>——Python 中的 <code>eval</code> 只能执行单纯的表达式，无法创建变量，而且需要 4 个字母；而 <code>exec</code> 可以执行代码块</li><li>Bash 用了 <code>tr</code></li><li>Ruby 选了 <code>c</code> 和另外两个数字——Ruby 中 <code>&#x3C;&#x3C;</code> 是字符串连接运算符，<code>\$></code> 是 <code>stdout</code>，后面用格式化字符串 <code>"%c"</code> 和一个整数数组</li><li>C 利用了 UB 和不平凡的编译命令</li><li>PHP 选了 <code>H</code>、<code>e</code>、<code>l</code>，剩下的字符惊为天人，不知道是利用了什么隐式类型转换，看不懂</li></ul><p>PowerShell 中无法对 Char 进行加减操作，显式地进行类型转换也需要类似 <code>[char]65</code> 至少 4 个字母。<sup><a href=#user-content-fn-3key1 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key1>2</a></sup> 所以只能考虑 eval。PowerShell 中的命令名都很长，不过 Invoke-Expression 有别名 <code>iex</code>。另外有一个可以执行字符串的操作符 <code>&#x26;</code>，但是只能是命令名，不能带参数。<sup><a href=#user-content-fn-3key2 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key2>3</a></sup></p><h3 id=第一个数字>第一个数字</h3><p>因为不能直接出现数字了，所以需要想办法得到第一个 Int 类型的值。发现数组下标为空字符串 <code>''</code> 时可以得到数组的第一个元素，但是如果想要后面的字母的话，PowerShell 并没有提供 pop 等函数。<sup><a href=#user-content-fn-3key3 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key3>4</a></sup> 数字字面量也都至少需要有 <code>0</code> 出现。所以只能通过其他类型隐式转换出 Int 来。</p><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#2f86d2>$i</span><span style=color:#002339> </span><span style=color:#7b30d0>=</span><span style=color:#002339> $? </span><span style=color:#7b30d0>+</span><span style=color:#002339> $?</span></span></code></pre></div><ul><li><code>\$?</code> 表示上一条命令的返回值，在初始时和上一条命令没有出错时为 <code>True</code>。<sup><a href=#user-content-fn-3key4 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key4>5</a></sup></li><li>PowerShell 中的 <code>==</code> 是 <code>-eq</code>，需要额外的字母。</li><li>当 Bool 类型转换为整数时，<code>True</code> 是 <code>1</code>，故 <code>\$i<code>为</code>2</code>。<sup><a href=#user-content-fn-3key5 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key5>6</a></sup></li></ul><p>剩下的大部分操作都是在构造其他数字，代码的长度应该可以再压缩一点。</p><h3 id=构造-unicode>构造 Unicode</h3><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#2f86d2>$x</span><span style=color:#002339> </span><span style=color:#7b30d0>=</span><span style=color:#002339> (</span><span style=color:#a44185>""</span><span style=color:#002339> </span><span style=color:#7b30d0>+</span><span style=color:#002339> $?)[</span><span style=color:#2f86d2>$i</span><span style=color:#002339>]</span></span></code></pre></div><ul><li><code>+</code> 运算符的两个参数类型不一致的时候，会将第二个参数隐式转换为第一个参数的类型。故此处 <code>\$e</code> 为 String <code>"True"</code>。</li></ul><p>至此，我们有了所需的数字和字母 <code>u</code>，可以用 <code>"u{x}"</code> 来生成一切字符了。不过，<code>"Hello World!"</code> 除了可以直接输入的 <code>e</code>、空格和 <code>!</code>，十六进制值中还需要 <code>c</code> 和 <code>f</code>。幸好这两个的编码分别为 <code>63</code> 和 <code>66</code>，没有 a-f 出现。<code>\$e</code> 实际上就是：</p><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#2f86d2>$e</span><span style=color:#002339> </span><span style=color:#7b30d0>=</span><span style=color:#002339> </span><span style=color:#a44185>"</span><span style=color:#174781>``</span><span style=color:#a44185>u{48}e</span><span style=color:#174781>``</span><span style=color:#a44185>u{6c}</span><span style=color:#174781>``</span><span style=color:#a44185>u{6c}</span><span style=color:#174781>``</span><span style=color:#a44185>u{6f}, </span><span style=color:#174781>``</span><span style=color:#a44185>u{57}</span><span style=color:#174781>``</span><span style=color:#a44185>u{6f}</span><span style=color:#174781>``</span><span style=color:#a44185>u{72}</span><span style=color:#174781>``</span><span style=color:#a44185>u{6c}</span><span style=color:#174781>``</span><span style=color:#a44185>u{64}!"</span><span style=color:#002339>;</span></span></code></pre></div><h4 id=转义字符>转义字符</h4><div data-rehype-pretty-code-fragment=""><pre data-language=powershell data-theme=default><code data-language=powershell data-theme=default><span class=line><span style=color:#002339>iex </span><span style=color:#a44185>"</span><span style=color:#174781>`$</span><span style=color:#a44185>ex=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xe</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>;</span><span style=color:#174781>`$</span><span style=color:#a44185>xe=</span><span style=color:#174781>""``</span><span style=color:#2f86d2>$x</span><span style=color:#a44185>{</span><span style=color:#2f86d2>$xx</span><span style=color:#a44185>}</span><span style=color:#174781>""</span><span style=color:#a44185>"</span></span></code></pre></div><ul><li>字符串用双引号的好处是可以直接嵌入变量。如果要 escape 的话，需要在 <code>\$</code>、<code>"</code>、<code>`</code> 前面加上 <code>`</code>；<code>"</code> 也可以自身重复两次 <code>""</code> 来 escape。<sup><a href=#user-content-fn-3key6 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key6>7</a></sup></li></ul><h3 id=打印值>打印值</h3><p>PowerShell 默认打印出前一个表达式的值，所以不需要拼凑出 <code>"echo"</code> 再 <code>iex</code> 什么的。</p><h3 id=其他可能的方法>其他可能的方法</h3><ul><li>变量赋值时可以直接是命令的输出。比如旧版 PowerShell 可以通过 <code>\$ls = ls; \$ls[x][x]</code> 拿到 ls 命令表头具体的一个 Char，或许有的命令的输出包含全部所需的字母。但是新版中大部分命令的输出不再是字符串而是对象了，两次下标拿到的仍然和原结果一样。</li><li><code>\$error</code> 是一个存放了错误信息字符串的数组。<sup><a href=#user-content-fn-3key7 aria-describedby=footnote-label data-footnote-ref="" id=user-content-fnref-3key7>8</a></sup> 不过，错误会直接输出，不符合「该程序运行后输出 Hello, World!, 有且仅有该内容，要求分毫不差」的要求。</li></ul><section class=footnotes data-footnotes=""><h2 id=footnote-label class=sr-only>脚注和参考文献</h2><ol><li id=user-content-fn-3psrank><p>点击第 5 条规则中的链接查看。 <a href=#user-content-fnref-3psrank aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key1><p><a href=https://community.idera.com/database-tools/powershell/powertips/b/tips/posts/converting-ascii-and-characters>Converting ASCII and Characters - Power Tips - Power Tips - IDERA Community</a> <a href=#user-content-fnref-3key1 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key2><p><a href=https://stackoverflow.com/questions/50018274/why-does-invoke-operator-and-invoke-expression-produce-different-results-for>Why does invoke operator (&#x26; and Invoke-Expression produce different results for the same input? - Stack Overflow)</a> <a href=#user-content-fnref-3key2 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key3><p><a href=https://stackoverflow.com/questions/24754822/powershell-remove-item-0-from-an-array>PowerShell Remove item 0 from an array - Stack Overflow</a> <a href=#user-content-fnref-3key3 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key4><p><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_automatic_variables?view=powershell-7.2#section-1">$? - PowerShell Core - About - Automatic Variables</a> <a href=#user-content-fnref-3key4 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key5><p><a href="https://docs.microsoft.com/en-us/powershell/scripting/lang-spec/chapter-06?view=powershell-7.2#64-conversion-to-integer">Conversion#Conversion to integer</a> <a href=#user-content-fnref-3key5 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key6><p><a href=https://www.rlmueller.net/PowerShellEscape.htm>Escaping in PowerShell</a> <a href=#user-content-fnref-3key6 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li><li id=user-content-fn-3key7><p><a href=https://www.tutorialspoint.com/what-is-use-of-error-variable-in-powershell>What is use of $error variable in PowerShell?</a> <a href=#user-content-fnref-3key7 aria-label=返回内容 class=data-footnote-backref data-footnote-backref="">↩</a></p></li></ol></section>